<odoo>
    <template id="contracts_template" name="Customer Contracts">
        <t t-call="website.layout">
            <div id="wrap" class="container mt-4">
                <h2>Danh sách hợp đồng</h2>

                <t t-if="contracts">
                    <table class="table table-bordered mt-3">
                        <thead>
                            <tr>
                                <th>Mã hợp đồng</th>
                                <th>Dịch vụ</th>
                                <th>Ngày bắt đầu</th>
                                <th>Ngày kết thúc</th>
                                <th>Trạng thái</th>
                                <th>Số tháng hợp đồng</th>
                                <th>Phí hàng tháng</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="contracts" t-as="c">
                                <tr>
                                    <td><t t-esc="c.contract_number"/></td>
                                    <td><t t-esc="c.service_id.name"/></td>
                                    <td><t t-esc="c.start_date"/></td>
                                    <td><t t-esc="c.end_date"/></td>
                                    <td><t t-esc="c.status"/></td>
                                    <td><t t-esc="c.contract_term"/></td>
                                    <td><t t-esc="c.monthly_amount"/></td>
                                    <td>
                                        <button type="button" class="btn btn-primary btn-sm"
                                            data-bs-toggle="modal"
                                            data-bs-target="#paymentModal"
                                            t-att-data-contract="c.id">
                                            Thanh toán
                                        </button>
                                    </td>
                                </tr>
                            </t>
                        </tbody>
                    </table>
                </t>
                <t t-else="">
                    <p>Khách hàng này chưa có hợp đồng nào.</p>
                </t>

                <div class="mt-3">
                    <a href="/home" class="btn btn-secondary">Quay lại tìm kiếm</a>
                </div>
            </div>

            <!-- Modal Thanh toán -->
            <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalLabel">Thanh toán hợp đồng</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <form id="paymentForm">
                        <div class="mb-3">
                            <label for="contractId" class="form-label">Mã hợp đồng</label>
                            <input type="text" class="form-control" id="contractId" readonly="readonly"/>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Chọn số tháng thanh toán</label>
                            <select class="form-select" id="months">
                                <option value="1">1 tháng</option>
                                <option value="3">3 tháng</option>
                                <option value="6">6 tháng</option>
                                <option value="12">12 tháng</option>
                            </select>
                        </div>
                    </form>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-success" id="confirmPayment">Xác nhận</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- JS để gán contract vào modal -->
            <script>
            document.addEventListener("DOMContentLoaded", function () {
              var paymentModal = document.getElementById("paymentModal");
              paymentModal.addEventListener("show.bs.modal", function (event) {
                var button = event.relatedTarget;
                var contractId = button.getAttribute("data-contract");
                paymentModal.querySelector("#contractId").value = contractId;
              });

              document.getElementById("confirmPayment").addEventListener("click", function () {
                var contractId = document.getElementById("contractId").value;
                var months = document.getElementById("months").value;

                fetch("/order", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    contract_id: contractId,
                    months_paid: months
                  }),
                })
                .then(res => res.json())
                .then(data => {
                  if (data.error) {
                    alert("Lỗi: " + data.error);
                  } else if (data.payment_url) {
                    window.location.href = data.payment_url;
                  } else {
                    alert("Không nhận được link thanh toán");
                  }
                })
                .catch(err => {
                  console.error(err);
                  alert("Có lỗi xảy ra khi tạo thanh toán");
                });

                bootstrap.Modal.getInstance(paymentModal).hide();
              });
            });
            </script>
        </t>
    </template>
</odoo>
